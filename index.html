<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Management App</title>
    <style>
        .due-today {
            color: red;
            font-weight: bold;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>All Index Loan Upcoming Due Dates</h1>
    <label for="allLenders">Filter by Lender:</label>
    <select id="allLenders" onchange="filterLoans(this.value, 'upcomingLoans')">
        <option value="">All</option>
        <!-- Add options for lenders dynamically if needed -->
    </select>
    <table id="upcomingLoans">
        <thead>
            <tr>
                <th>Date</th>
                <th>Lender</th>
                <th>Reference</th>
                <th>Capital</th>
                <th>Interest</th>
                <th>Installment</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h1>NCRCS Loans</h1>
    <label for="ncrcsLenders">Filter by Lender:</label>
    <select id="ncrcsLenders" onchange="filterLoans(this.value, 'ncrcsLoans')">
        <option value="">All</option>
        <!-- Add options for lenders dynamically if needed -->
    </select>
    <table id="ncrcsLoans">
        <thead>
            <tr>
                <th>Date</th>
                <th>Lender</th>
                <th>Reference</th>
                <th>Capital</th>
                <th>Interest</th>
                <th>Installment</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h1>Expired Loans</h1>
    <label for="expiredLenders">Filter by Lender:</label>
    <select id="expiredLenders" onchange="filterLoans(this.value, 'expiredLoans')">
        <option value="">All</option>
        <!-- Add options for lenders dynamically if needed -->
    </select>
    <table id="expiredLoans">
        <thead>
            <tr>
                <th>Date</th>
                <th>Lender</th>
                <th>Reference</th>
                <th>Capital</th>
                <th>Interest</th>
                <th>Installment</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="createdBy">Created by: M I Ammar Saneej</div>

    <script>
        const apiKey = 'AIzaSyDdIZz5120-LxJmhLsMHgfvgAil3G7-GI8';
        const spreadsheetId = '1E73ERVtf9KhxbyaiguEkg96aKyc4sCZkFgq0cxmlEUM';

        fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Sheet1?key=${apiKey}`)
            .then(response => response.json())
            .then(data => {
                const loansData = data.values;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const lenders = loansData[0];
                const allLendersSelect = document.getElementById('allLenders');
                const ncrcsLendersSelect = document.getElementById('ncrcsLenders');
                const expiredLendersSelect = document.getElementById('expiredLenders');

                for (let i = 1; i < lenders.length; i++) {
                    const option = document.createElement('option');
                    option.text = lenders[i];
                    option.value = lenders[i];
                    allLendersSelect.add(option);
                    ncrcsLendersSelect.add(option.cloneNode(true));
                    expiredLendersSelect.add(option.cloneNode(true));
                }

                const upcomingTable = document.getElementById('upcomingLoans');
                const ncrcsTable = document.getElementById('ncrcsLoans');
                const expiredTable = document.getElementById('expiredLoans');

                function filterLoans(selectedLender, tableId) {
                    const table = tableId === 'upcomingLoans' ? upcomingTable : (tableId === 'ncrcsLoans' ? ncrcsTable : expiredTable);
                    const tableBody = table.querySelector('tbody');
                    let tableContent = '';

                    for (let i = 1; i < loansData.length; i++) {
                        const row = loansData[i];
                        const loanDate = new Date(row[0]);
                        loanDate.setHours(0, 0, 0, 0);
                        const lenderName = row[1];

                        if ((lenderName === selectedLender || selectedLender === '') && tableId === 'upcomingLoans') {
                            const timeDiff = (loanDate - today) / (1000 * 60 * 60 * 24);
                            if (timeDiff >= 0 && timeDiff <= 30) {
                                const remarks = loanDate.getTime() === today.getTime() ? "<span class='due-today'>Due Today</span>" : `Due in ${Math.ceil(timeDiff)} days`;
                                tableContent += buildTableRow(row, lenderName, loanDate, 2, remarks);
                            }
                        } else if ((lenderName === selectedLender || selectedLender === '') && tableId === 'ncrcsLoans') {
                            const timeDiff = (loanDate - today) / (1000 * 60 * 60 * 24);
                            if (lenderName.includes("NCRCS") && timeDiff >= 0 && timeDiff <= 30) {
                                const remarks = loanDate.getTime() === today.getTime() ? "<span class='due-today'>Due Today</span>" : `Due in ${Math.ceil(timeDiff)} days`;
                                tableContent += buildTableRow(row, lenderName, loanDate, 2, remarks);
                            }
                        } else if ((lenderName === selectedLender || selectedLender === '') && tableId === 'expiredLoans') {
                            const timeDiff = (loanDate - today) / (1000 * 60 * 60 * 24);
                            if (timeDiff < 0 && timeDiff >= -14) {
                                tableContent += buildTableRow(row, lenderName, loanDate, 2, `Delete in ${14 + Math.ceil(timeDiff)} days`);
                            }
                        }
                    }

                    tableBody.innerHTML = tableContent || "<tr><td colspan='7'>No loans to display.</td></tr>";
                }

                function buildTableRow(row, lenderName, loanDate, columnIndex, remarks) {
                    return `
                        <tr>
                            <td>${loanDate.toLocaleDateString()}</td>
                            <td>${lenderName}</td>
                            <td>${row[columnIndex] || ''}</td>
                            <td>${row[columnIndex + 1] || ''}</td>
                            <td>${row[columnIndex + 2] || ''}</td>
                            <td>${row[columnIndex + 3] || ''}</td>
                            <td>${remarks}</td>
                        </tr>
                    `;
                }

                filterLoans('', 'upcomingLoans');
                filterLoans('', 'ncrcsLoans');
                filterLoans('', 'expiredLoans');
            })
            .catch(error => {
                console.error('Error:', error);
            });
    </script>
</body>
</html>
